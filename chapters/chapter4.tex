%************************************************
\chapter{Local algorithm}\label{ch:local}
%************************************************

In this Chapter will be defined a local Metropolis-Hastings algorithm that samples the link variables.
Then, a specific local algorithm will be defined to compute the integral of Equation \eqref{eq:lat_exp}.
The first simulation will be run,
and the result of the plaquette mean value will be compared with the value reported by D\"urr and Hoelbling in 2005 \cite{durr-hoelbling:2005}.

However, since the algorithm is local, at small lattice spacing, the topological freezing will be encountered.

\section{Link variables updating}
\subsection*{Heat-bath}
%\begin{align*}
%    S &= \beta\sum_s\left(1-\Re\,U[\mathcal P(s)]\right) \\
%    \Delta S &= -\beta\Re\,\left(U[\mathcal S_0]U[\mathcal L] + U[\mathcal S_1]U[\mathcal L]\right) \\
%             &= -\beta\Re\,(Wu) \\
%             &= -\beta|W|\cos(\phi + \arg W) \\
%             &= e^{-k\cos(x)}
%\end{align*}
The probability density function of links configurations $\{U\}$ is:
\[
    p(U) \propto e^{-S}
\]
in which the action $S$ is:
\[
    S = \beta\sum_s\left(1-\Re\,U[\mathcal P(s)]\right)
\]
Every plaquette value $\Re\,U[\mathcal P(s)]$ depends on four links variables,
and every link variable contributes to two different plaquettes.

Links variables are then simultaneously coupled in their probability density function,
which is then impossible to sample directly.

However, the action has a local nature,
since every link variable contributes only to the two plaquettes that include it.
Thus, using the heat-bath approach and considering only the marginal distribution of one link variable,
the contribution of all plaquettes that do not include the link can be integrated out of the distribution.

Let $\mathcal L$ be the link considered, and $\mathcal P_1, \mathcal P_2$ the two plaquettes that include it.
The two paths $\mathcal S_1, \mathcal S_2$ sketched in Figure \ref{fig:staples}
are called \emph{staples}.
They are all the staples connected to $\mathcal L$,
in the sense that they are the staples that form a plaquette if $\mathcal L$ is included to them.

\begin{figure}[!htb]
    \centering
    \begin{tikzpicture}[x=5em,y=5em]
        \draw[step=1, help lines, dashed, color=black!30] (0,0) grid (3.5,2.5);
        \draw[->,thick,black] (0,0) -- (3.5,0) node [right] {$x_1$};
        \draw[->,thick,black] (0,0) -- (0,2.5) node [above] {$x_2$};

        \draw[->-,very thick,orange] (2,1) node [black,below] {$\mathcal L$} --  (2,2);

        %left staple
        \draw[->-,very thick,RoyalBlue] (2,2) -- (1,2);
        \draw[->-,very thick,RoyalBlue] (1,2) -- node [black,left] {$\mathcal S_1$} (1,1);
        \draw[->-,very thick,RoyalBlue] (1,1) -- (2,1);

        %right staple
        \draw[->-,very thick,RoyalBlue] (2,2) -- (3,2);
        \draw[->-,very thick,RoyalBlue] (3,2) -- node [black,right] {$\mathcal S_2$} (3,1);
        \draw[->-,very thick,RoyalBlue] (3,1) -- (2,1);

        %left plaq
        \draw[->-,thick,dashed,black] (1.2,1.2) -- (1.8,1.2);
        \draw[->-,thick,dashed,black] (1.8,1.2) -- (1.8,1.8);
        \draw[->-,thick,dashed,black] (1.8,1.8) -- (1.2,1.8);
        \draw[->-,thick,dashed,black] (1.2,1.8) -- (1.2,1.2);
        \node at (1.5,1.5) {$\mathcal P_1$};

        %right plaq
        \draw[->-,thick,dashed,black] (2.2,1.2) -- (2.8,1.2);
        \draw[->-,thick,dashed,black] (2.8,1.2) -- (2.8,1.8);
        \draw[->-,thick,dashed,black] (2.8,1.8) -- (2.2,1.8);
        \draw[->-,thick,dashed,black] (2.2,1.8) -- (2.2,1.2);
        \node at (2.5,1.5) {$\mathcal P_2$};

        %\node[anchor={north east}] at (1,1) {$\mathcal P_1$};
        %\node[anchor={north east}] at (2,1) {$\mathcal P_2$};

    \end{tikzpicture}
    \caption{Staples connected to a vertical link}
    \label{fig:staples}
\end{figure}

The contribution of $\mathcal P_1, \mathcal P_2$ to the action can be written in terms of
the link variable $u \equiv U[\mathcal L]$ in the following way:
\[\begin{aligned}
    \Re\,U[\mathcal P_1] + \Re\,U[\mathcal P_2] &= \Re\,(uU[\mathcal S_1]) + \Re\,(u^*U^*[\mathcal S_2]) \\
                                                &= \Re\,(Wu)
\end{aligned}\]
where $W \equiv U[\mathcal P_1] + U[\mathcal P_2] \notin U(1)$ has a modulus $|W|\neq1$.
Thus, the marginal distribution of $u$ with all the other link variables kept fixed at $u_\mathrm{fix}$ is:
\[\begin{aligned}
    p(u;u_\mathrm{fix}) &\propto e^{-\beta(1-\Re(Wu))} \\
                        &\propto e^{\beta\Re(Wu)} \\
                        &= e^{\beta|W|\Re\left(u_0\right)}
\end{aligned}\]
Here, $u_0 \equiv \frac{W}{|W|}u \in U(1)$, and $\mathrm du_0=\mathrm du$ are then the same Haar measure of the compact group $U(1)$.
Which means:
\[
    p(u;u_\mathrm{fix}) = p(u_0;u_\mathrm{fix}) \propto e^{\beta|W|\Re\left(u_0\right)}
\]
Indeed, $u$ can be parameterized as $u\equiv e^{i\phi}$ in which $\phi$ is defined in $(-\pi + \phi_0, \pi + \phi_0]$ with a generic $\phi_0$.
After a transformation $u \rightarrow \frac{W}{|W|}u$, $\phi$ undergoes the translation $\phi \rightarrow \phi + \arg W$.
If the parameterization is redefined as $\phi_0 \rightarrow \phi_0 - \arg W$, the shift of the definition interval of $\phi$ is then reabsorbed.

Choosing to parameterize $u_0 \equiv e^{ix}$ with $x \in (-\pi, \pi]$,
the marginal distribution of $x$ finally is:
\begin{equation}\label{eq:local_pdf}
    p(x;u_\mathrm{fix}) \propto e^{k\cos(x)} \quad x \in (-\pi, \pi]
\end{equation}
with $k \equiv \beta|W|$.
Equation \eqref{eq:local_pdf} cannot be integrated analytically,
therefore it is not possible to directly sample it.

It was chosen to sample it using a Metropolis-Hastings algorithm,
which means that a proposal distribution $\mathcal P(x\to y)$ has to be defined.

For what has been said at the end of Chapter \ref{ch:mc},
the acceptance of the algorithm increases as much similar $\mathcal P(x\to y)$ gets to $p(x;u_\mathrm{fix})$.

On this matter, Laplaces's method identifies such a distribution.
Indeed it is its corollary that any unimodal distribution of the form $\propto e^{kf(x)}$ approaches to a Gaussian as $k$ increases.

In particular, it proves that (Figure \ref{fig:gauss}):
\begin{equation}\label{eq:gauss_approx}
    e^{k\cos(x)} \stackrel{k\to\infty}{\scalebox{2}[1.25]{$\sim$}} e^{-kx^2/2}
\end{equation}

\begin{figure}[!htb]
    \centering
    \input{plots/gauss.pgf}
    \caption{$p(x;u_\mathrm{fix})$ converges to a Gaussian as $k$ increases}
    \label{fig:gauss}
\end{figure}

Laplace's method states that, if $f(x)$ is a twice-differentiable function that has only one maximum point $x_0 \in [a,b]$ with $x_0 \neq a,b$,
then:
\begin{equation}\label{eq:laplace}
	\int_a^b\mathrm dx\,e^{kf(x)} \xrightarrow{k\to\infty} e^{kf(x_0)}\int_a^b\mathrm dx\,e^{kf"(x_0)(x-x_0)^2/2}
\end{equation}
Indeed, as $k$ increases, the points that are further from the maximum point $x_0$ are exponentially suppressed,
and only the points in the range of $x_0$ becomes relevant to the integral.
The order zero of the Taylor expansion of $f(x)$ around $x_0$ is a multiplicative constant and the order one does not contribute since it is symmetric.
The meaningful part is then the second order, which is negative since $x_0$ is a maximum,
and hence the integrand of the second term of Equation \eqref{eq:laplace} is a Gaussian.

Applying Laplace's method for the case of Equatiton \eqref{eq:local_pdf},
the global maximum is $x_0=0$, and $f"(x_0) = -1$.
Thus:
\[
    \int_{-\pi}^x\mathrm dx'\,e^{k\cos(x')} \stackrel{k\to\infty}{\scalebox{2}[1.25]{$\sim$}} \int_{-\pi}^x\mathrm dx'\,e^{-k{x'}^2/2} \quad \mathrm{for}\ x>0
\]
and equation \eqref{eq:gauss_approx} is recovered taking the derivative of both members, and extending the results for symmetry around $0$.

\subsection*{Gaussian sampling}
The proposal distribution has then been chosen to be:
\[
    \mathcal P(x\to y) \propto e^{-kx^2/2}
\]




\[
    p(x) \propto e^{-\frac{k}{2}x^2}
\]

\[
    p(x_1,x_2) \propto e^{-\frac{k}{2}(x_1^2+x_2^2)}
\]

\[\begin{dcases}
    x_1 = r \cos\theta \\
    x_2 = r \sin\theta \\
\end{dcases}\]

\[\begin{aligned}
    p(r,\theta) &= p(r)p(\theta) \\
                &= \left(\mathcal Nre^{-\frac{k}{2}r^2}\right)\left(\frac{1}{2\pi}\right)
\end{aligned}\]
\[
    F(r) = \int_0^r\mathrm dr'\,p(r') = \frac{\mathcal N}{k}\left.e^{-\frac{k}{2}{r'}^2}\right|_r^0 = \frac{\mathcal N}{k}\left(1-e^{-\frac{k}{2}r^2}\right) \equiv y_1
\]
\[
    r = F^{-1}(y_1) = \sqrt{-\frac{2}{k}\log\left(1-\frac{k}{\mathcal N}y_1\right)}
\]
\[
    \mathcal N^{-1} = \int_0^\pi\mathrm dr\,re^{-\frac{k}{2}r^2} = \frac{1}{k}\left(1-e^{-\frac{k}{2}\pi^2}\right)
\]
\begin{equation*}
    \begin{dcases}
        x_1 = -\frac{k}{2}\log\left[1-y_1\left(1-e^{-\frac{k}{2}\pi^2}\right)\right]\cos(2\pi y_2) \\
        x_2 = -\frac{k}{2}\log\left[1-y_1\left(1-e^{-\frac{k}{2}\pi^2}\right)\right]\sin(2\pi y_2)
    \end{dcases}
\end{equation*}

\subsection{Local Metropolis-Hastings}

\section{First results}

\subsection{Plaquette mean value}

\subsection{Topological freezing}

%*****************************************
%*****************************************
%*****************************************
%*****************************************
%*****************************************
